---
################################################################################
# Set up the local repo - the mock builder user should have ownership
- name: "Ensure the bootstrap repos for {{ mock_builder }} exit"
  file:
    path: '{{ item }}'
    owner: '{{ mock_builder }}'
    group: '{{ mock_builder }}'
    mode: '0755'
    state: directory
  loop:
    - "{{ repo_drop_path }}"
    - "{{ repo_drop_path_results }}"
  become: true
  become_user: root
  tags:
    - mock

################################################################################
# Create the repos if it isn't ready
- name: Stat the repo drop path repodata
  stat:
    path: "{{ repo_drop_path }}/repodata"
  register: repodata_dir
  tags:
    - mock

- name: Run a createrepo if necessary
  command:
    argv:
      - '/usr/bin/createrepo_c'
      - '--xz'
      - '--checksum=sha256'
      - '--revision={{ full }}'
      - '--workers=8'
      - '--distro=cpe:/o:{{ distro }}:{{ distro }}:{{ major }},{{ mock_vendor }} {{ major }}'
      - '{{ repo_drop_path }}'
  when:
    - not repodata_dir.stat.exists
  tags:
    - mock
...
