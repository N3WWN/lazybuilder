---
################################################################################
# createrepo wrapper
- name: Perform local createrepo with our finished rpms
  block:
    - name: "Run createrepo for {{ repo_drop_path }}"
      command:
        argv:
          - '/usr/bin/createrepo_c'
          - '--xz'
          - '--checksum=sha256'
          - '--revision={{ full }}'
          - '--workers=8'
          - '--distro=cpe:/o:{{ distro }}:{{ distro }}:{{ major }},{{ mock_vendor }} {{ major }}'
          - '{{ repo_drop_path }}'
      register: createrepo_finish
      ignore_errors: true
      tags:
        - createrepo
  rescue:
    - name: We failed, display the error.
      debug:
        msg: "Failed to setup repo: {{ ansible_failed_result }}"

    - name: Perform full cleanup
      file:
        path: '{{ item }}'
        state: absent
      loop:
        - '/home/{{ mock_builder }}/rpmbuild'
        - '/home/{{ mock_builder }}/{{ source_name }}'
        - '/home/{{ mock_builder }}/mock-wrapper.sh'
        - '/home/{{ mock_builder }}/{{ distro }}-{{ major }}-{{ mock_arch }}.cfg'
        - '/var/tmp/.build_in_progress'

    - name: Fail when there's an error in the block
      fail:
        msg: "Exiting entire play"
  when:
    - (repo_host == "localhost") or (transfer_type == "nfs")
  tags:
    - createrepo

- name: Perform remote createrepo
  block:
    - name: createrepo
      debug:
        msg: createrepo
  when:
    - (not repo_host == "localhost") and (not transfer_type == "nfs")
  tags:
    - createrepo
...
